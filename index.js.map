{"version":3,"sources":["src/index.js"],"names":["files","options","ps","map","name","sr","all","then","values","combine","cifar10","trainFiles","X_train","X","y_train","y","testFiles","X_test","y_test","code","console","log","__dirname","load","bufferSplit","isStream","createStream","createPromise","bufs","divider","length","quotient","range","slice","i","flatten","arr","reduce","acc","concat","start","end","result","push","stream","pipe","dir","join","getFileName","postfix","cols","rows","channel","valueSize","totalSize","mapper","chunk","Uint8Array","buf","filename","createReadStream","highWaterMark","on","err","error","config","output","resolve","reject","converter","data","resolver","ret","removeListeners","removeListener","e"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","file":"index.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport assert from 'assert';\n\n/* Library */\nexport function bufferSplit(bufs, divider){\n  assert(bufs.length % divider === 0);\n  const quotient = bufs.length / divider;\n  return range(divider).map(i => bufs.slice(quotient * i, quotient * (i+1)));\n}\n\nfunction flatten(arr) {\n  return arr.reduce((acc, {X, y}) => {\n    acc.X = acc.X.concat(X);\n    acc.y = acc.y.concat(y);\n    return acc;\n  }, {\n    X: [],\n    y: []\n  });\n} \n\nfunction range(start, end=start) {\n  if (start === end) start = 0;\n  const result = [];\n\n  for (let i=start; i<end; i++) \n    result.push(i);\n\n  return result;\n}\n\nexport function isStream(stream) {\n  return stream !== null &&\n    typeof stream === 'object' &&\n    typeof stream.pipe === 'function';\n}\n\n/* Configuration CIFAR-10 */\nexport const cifar10 = {\n  dir: path.join(__dirname, 'cifar-10-batches-bin'),\n  getFileName : function(postfix) {\n    return `${this.dir}/data_batch_${postfix}.bin`;\n  },\n  get trainFiles() {\n    return range(1,6).map(i => this.getFileName(i));\n  },\n  get testFiles(){\n    return [`${this.dir}/test_batch.bin`];\n  }, \n  cols: 32,\n  rows: 32,\n  channel: 3,\n  valueSize: 1,\n  get totalSize() {\n    return this.valueSize + this.channel * this.cols * this.rows;\n  },\n  mapper: function (chunk) {\n    const y = chunk[0];\n    const X = bufferSplit(chunk.slice(this.valueSize), this.channel)\n              .map(buf => new Uint8Array(buf));\n    return { X, y };\n  }\n}\n\n\n/* Main  */\nexport function createStream(filename, {totalSize}){\n  const stream = fs.createReadStream(filename, {highWaterMark:totalSize});\n\n  stream.on('error', (err) => {\n    if (err.code === 'ENOENT')\n      console.error(`Data files are not existed. Run '${__dirname}/get_datasets.sh'`)\n      throw err;\n  });\n\n  return stream;\n}\n\nexport function createPromise(stream, config) {\n  let output = [];\n  if (!isStream(stream)) {\n    return Promise.resolve(config.mapper(stream));\n  }\n\n  return new Promise((resolve, reject) => {\n    function converter(data) {\n      output.push(config.mapper(data));\n    }\n\n    function resolver() {\n      const ret = output.reduce((acc, {X, y}) => {\n        acc.X.push(X);\n        acc.y.push(y);\n        return acc;\n      }, {\n        X: [],\n        y: []\n      });\n      resolve(ret);\n      output = null;\n      removeListeners();\n    }\n\n    function removeListeners() {\n      stream.removeListener('data', converter)\n      stream.removeListener('end', resolver)\n      stream.removeListener('close', resolver)\n    }\n\n    try {\n      stream.on('data', converter);        // stream.on('data', function(data) {\n      stream.on('end', resolver); \n      stream.on('close', resolver); \n    }\n    catch(e) /*istanbul ignore next*/ {\n      removeListeners();\n      reject(e);\n    }\n  });\n}\n\nexport async function combine(files, options) {\n  const ps = files.map(name => createStream(name, options))\n                  .map(sr => createPromise(sr, options));\n  return await Promise.all(ps).then(values => flatten(values));\n}\n\nexport async function load(options=cifar10) {\n  try{\n    const { X: X_train, y: y_train } = await combine(options.trainFiles, options);\n    const { X: X_test, y: y_test } = await combine(options.testFiles, options);\n\n    return {\n      X_train,\n      y_train,\n      X_test,\n      y_test\n    }\n  }\n  catch(err) {\n    if (err.code === 'ENOENT')\n    console.log(`Data files are not existed. Run '${__dirname}/get_datasets.sh'`)\n    throw err;\n  }\n}\n\nexport default {\n  createStream,\n  createPromise,\n  combine,\n  load,\n}\n"]}